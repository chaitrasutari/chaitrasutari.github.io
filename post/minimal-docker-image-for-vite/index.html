<!DOCTYPE html><p>Recently, Iâ€™ve been preparing to migrate projects hosted on Cloudflare, Vercel, and Netlify to my own VPS to run via Docker. I revisited Docker image packaging. However, even a small project ended up being packaged into a 1.05GB image, which is clearly unacceptable. So, I researched minimal Docker image packaging for Node.js projects, reducing the image size from 1.06GB to 135MB.</p>
<p>The example project is an Astro project using Vite as the build tool, running in SSR mode.</p>
<h2 id="version-0">Version 0</h2>
<blockquote>
<p>The main idea is to use a minimal system image, opting for the Alpine Linux image.</p>
</blockquote>
<p>Following the <a href="https://docs.astro.build/en/recipes/docker/#ssr">Astro official documentation for Server-Side Rendering (SSR)</a>, I replaced the base image with node:lts-alpine, and switched from NPM to PNPM. The resulting image size was 1.06GB, which is the worst-case scenario.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="dockerfile"><code><span class="line"><span style="color:#F97583">FROM</span><span style="color:#E1E4E8"> node:lts-alpine </span><span style="color:#F97583">AS</span><span style="color:#E1E4E8"> base</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">ENV</span><span style="color:#E1E4E8"> PNPM_HOME=</span><span style="color:#9ECBFF">"/pnpm"</span></span>
<span class="line"><span style="color:#F97583">ENV</span><span style="color:#E1E4E8"> PATH=</span><span style="color:#9ECBFF">"$PNPM_HOME:$PATH"</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> corepack enable</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">WORKDIR</span><span style="color:#E1E4E8"> /app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">COPY</span><span style="color:#E1E4E8"> . .</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> pnpm install --frozen-lockfile</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> export $(cat .env.example) &#x26;&#x26; pnpm run build</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">ENV</span><span style="color:#E1E4E8"> HOST=0.0.0.0</span></span>
<span class="line"><span style="color:#F97583">ENV</span><span style="color:#E1E4E8"> PORT=4321</span></span>
<span class="line"><span style="color:#F97583">EXPOSE</span><span style="color:#E1E4E8"> 4321</span></span>
<span class="line"><span style="color:#F97583">CMD</span><span style="color:#E1E4E8"> node ./dist/server/entry.mjs</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="log"><code><span class="line"><span style="color:#E1E4E8">docker build -t v0 .</span></span>
<span class="line"><span style="color:#E1E4E8">[+] Building </span><span style="color:#79B8FF">113</span><span style="color:#E1E4E8">.8s (</span><span style="color:#79B8FF">11</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">11</span><span style="color:#E1E4E8">) FINISHED                                                                                                                                        docker:orbstack</span></span>
<span class="line"><span style="color:#E1E4E8"> => [internal] load build definition from Dockerfile                                                                                                                                   </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => transferring dockerfile: 346B                                                                                                                                                   </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [internal] load metadata for docker.io/library/node:lts-alpine                                                                                                                     </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">.1s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [internal] load .dockerignore                                                                                                                                                      </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => transferring context: 89B                                                                                                                                                       </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">] FROM docker.io/library/node:lts-alpine@sha256:1a526b97cace6b4006256570efa1a29cd1fe4b96a5301f8d48e87c5139438a45                                                               </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [internal] load build context                                                                                                                                                      </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.2s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => transferring context: </span><span style="color:#79B8FF">240</span><span style="color:#E1E4E8">.11kB                                                                                                                                                  </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.2s</span></span>
<span class="line"><span style="color:#E1E4E8"> => CACHED [</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">] RUN corepack enable                                                                                                                                                   </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => CACHED [</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">] WORKDIR /app                                                                                                                                                          </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">] COPY . .                                                                                                                                                                     </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [</span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">] RUN pnpm install --frozen-lockfile                                                                                                                                          </span><span style="color:#79B8FF">85</span><span style="color:#E1E4E8">.7s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [</span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">] RUN export $(cat .</span><span style="color:#79B8FF">env.example</span><span style="color:#E1E4E8">) &#x26;&#x26; pnpm run build                                                                                                      </span><span style="color:#79B8FF">11</span><span style="color:#E1E4E8">.1s</span></span>
<span class="line"><span style="color:#E1E4E8"> => exporting to image                                                                                                                                                                </span><span style="color:#79B8FF">13</span><span style="color:#E1E4E8">.4s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => exporting layers                                                                                                                                                               </span><span style="color:#79B8FF">13</span><span style="color:#E1E4E8">.4s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => writing image sha256:653236defcbb8d99d83dc550f1deb55e48b49d7925a295049806ebac8c104d4a                                                                                           </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => naming to docker.io/library/v0</span></span></code></pre>
<h2 id="version-1">Version 1</h2>
<blockquote>
<p>The main idea is to first install production dependencies, creating the first layer. Then install all dependencies, package to generate JavaScript artifacts, creating the second layer. Finally, copy the production dependencies and JavaScript artifacts to the runtime environment.</p>
</blockquote>
<p>Following the <a href="https://docs.astro.build/en/recipes/docker/#multi-stage-build-using-ssr">multi-stage build (using SSR)</a> approach, I reduced the image size to 306MB. This is a significant reduction, but the drawback is that <strong>it requires explicitly specifying production dependencies; if any are missed, runtime errors will occur</strong>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="dockerfile"><code><span class="line"><span style="color:#F97583">FROM</span><span style="color:#E1E4E8"> node:lts-alpine </span><span style="color:#F97583">AS</span><span style="color:#E1E4E8"> base</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">ENV</span><span style="color:#E1E4E8"> PNPM_HOME=</span><span style="color:#9ECBFF">"/pnpm"</span></span>
<span class="line"><span style="color:#F97583">ENV</span><span style="color:#E1E4E8"> PATH=</span><span style="color:#9ECBFF">"$PNPM_HOME:$PATH"</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> corepack enable</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">WORKDIR</span><span style="color:#E1E4E8"> /app</span></span>
<span class="line"><span style="color:#F97583">COPY</span><span style="color:#E1E4E8"> package.json pnpm-lock.yaml ./</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">FROM</span><span style="color:#E1E4E8"> base </span><span style="color:#F97583">AS</span><span style="color:#E1E4E8"> prod-deps</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --prod --frozen-lockfile</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">FROM</span><span style="color:#E1E4E8"> base </span><span style="color:#F97583">AS</span><span style="color:#E1E4E8"> build-deps</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">FROM</span><span style="color:#E1E4E8"> build-deps </span><span style="color:#F97583">AS</span><span style="color:#E1E4E8"> build</span></span>
<span class="line"><span style="color:#F97583">COPY</span><span style="color:#E1E4E8"> . .</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> export $(cat .env.example) &#x26;&#x26; pnpm run build</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">FROM</span><span style="color:#E1E4E8"> base </span><span style="color:#F97583">AS</span><span style="color:#E1E4E8"> runtime</span></span>
<span class="line"><span style="color:#F97583">COPY</span><span style="color:#E1E4E8"> --from=prod-deps /app/node_modules ./node_modules</span></span>
<span class="line"><span style="color:#F97583">COPY</span><span style="color:#E1E4E8"> --from=build /app/dist ./dist</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">ENV</span><span style="color:#E1E4E8"> HOST=0.0.0.0</span></span>
<span class="line"><span style="color:#F97583">ENV</span><span style="color:#E1E4E8"> PORT=4321</span></span>
<span class="line"><span style="color:#F97583">EXPOSE</span><span style="color:#E1E4E8"> 4321</span></span>
<span class="line"><span style="color:#F97583">CMD</span><span style="color:#E1E4E8"> node ./dist/server/entry.mjs</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="log"><code><span class="line"><span style="color:#E1E4E8">docker build -t v1 .</span></span>
<span class="line"><span style="color:#E1E4E8">[+] Building </span><span style="color:#79B8FF">85</span><span style="color:#E1E4E8">.5s (</span><span style="color:#79B8FF">15</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">15</span><span style="color:#E1E4E8">) FINISHED                                                                                                                                         docker:orbstack</span></span>
<span class="line"><span style="color:#E1E4E8"> => [internal] load build definition from Dockerfile                                                                                                                                   </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.1s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => transferring dockerfile: 680B                                                                                                                                                   </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [internal] load metadata for docker.io/library/node:lts-alpine                                                                                                                     </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">.8s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [internal] load .dockerignore                                                                                                                                                      </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => transferring context: 89B                                                                                                                                                       </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [base </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">] FROM docker.io/library/node:lts-alpine@sha256:1a526b97cace6b4006256570efa1a29cd1fe4b96a5301f8d48e87c5139438a45                                                          </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [internal] load build context                                                                                                                                                      </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.3s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => transferring context: </span><span style="color:#79B8FF">240</span><span style="color:#E1E4E8">.44kB                                                                                                                                                  </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.2s</span></span>
<span class="line"><span style="color:#E1E4E8"> => CACHED [base </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">] RUN corepack enable                                                                                                                                              </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => CACHED [base </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">] WORKDIR /app                                                                                                                                                     </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [base </span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">] COPY </span><span style="color:#79B8FF">package.json</span><span style="color:#79B8FF"> pnpm-lock.yaml</span><span style="color:#E1E4E8"> ./                                                                                                                                     </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.2s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [prod-deps </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">] RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --prod --frozen-lockfile                                                                           </span><span style="color:#79B8FF">35</span><span style="color:#E1E4E8">.1s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [build-deps </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">] RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile                                                                                 </span><span style="color:#79B8FF">65</span><span style="color:#E1E4E8">.5s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [runtime </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">] COPY --from=prod-deps /app/node_modules ./node_modules                                                                                                               </span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">.9s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [build </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">] COPY . .                                                                                                                                                               </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.8s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [build </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">] RUN export $(cat .</span><span style="color:#79B8FF">env.example</span><span style="color:#E1E4E8">) &#x26;&#x26; pnpm run build                                                                                                                       </span><span style="color:#79B8FF">7</span><span style="color:#E1E4E8">.5s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [runtime </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">] COPY --from=build /app/dist ./dist                                                                                                                                   </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.1s</span></span>
<span class="line"><span style="color:#E1E4E8"> => exporting to image                                                                                                                                                                 </span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">.2s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => exporting layers                                                                                                                                                                </span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">.1s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => writing image sha256:8ae6b2bddf0a7ac5f8ad45e6abb7d36a633e384cf476e45fb9132bdf70ed0c5f                                                                                           </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => naming to docker.io/library/v1</span></span></code></pre>
<h2 id="version-2">Version 2</h2>
<blockquote>
<p>The main idea is to inline node_modules into the JavaScript files, ultimately copying only the JavaScript files to the runtime environment.</p>
</blockquote>
<p>When I looked into Next.js, I remembered that node_modules could be inlined into JavaScript files, eliminating the need for node_modules. So, I researched and found that Vite SSR also supports this. Therefore, I decided to use the inlining method in the Docker environment, avoiding the need to copy node_modules, and only copying the final dist artifacts, reducing the image size to 135MB.</p>
<p>Changes to the packaging script:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#B392F0">vite</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#B392F0">  ssr</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#B392F0">    noExternal</span><span style="color:#E1E4E8">: process.env.</span><span style="color:#79B8FF">DOCKER</span><span style="color:#F97583"> ?</span><span style="color:#F97583"> !!</span><span style="color:#E1E4E8">process.env.</span><span style="color:#79B8FF">DOCKER</span><span style="color:#F97583"> :</span><span style="color:#79B8FF"> undefined</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><strong>The final Dockerfile is as follows</strong>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="dockerfile"><code><span class="line"><span style="color:#F97583">FROM</span><span style="color:#E1E4E8"> node:lts-alpine </span><span style="color:#F97583">AS</span><span style="color:#E1E4E8"> base</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">ENV</span><span style="color:#E1E4E8"> PNPM_HOME=</span><span style="color:#9ECBFF">"/pnpm"</span></span>
<span class="line"><span style="color:#F97583">ENV</span><span style="color:#E1E4E8"> PATH=</span><span style="color:#9ECBFF">"$PNPM_HOME:$PATH"</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> corepack enable</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">WORKDIR</span><span style="color:#E1E4E8"> /app</span></span>
<span class="line"><span style="color:#F97583">COPY</span><span style="color:#E1E4E8"> package.json pnpm-lock.yaml ./</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># FROM base AS prod-deps</span></span>
<span class="line"><span style="color:#6A737D"># RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --prod --frozen-lockfile</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">FROM</span><span style="color:#E1E4E8"> base </span><span style="color:#F97583">AS</span><span style="color:#E1E4E8"> build-deps</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">FROM</span><span style="color:#E1E4E8"> build-deps </span><span style="color:#F97583">AS</span><span style="color:#E1E4E8"> build</span></span>
<span class="line"><span style="color:#F97583">COPY</span><span style="color:#E1E4E8"> . .</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> export $(cat .env.example) &#x26;&#x26; export DOCKER=true &#x26;&#x26; pnpm run build</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">FROM</span><span style="color:#E1E4E8"> base </span><span style="color:#F97583">AS</span><span style="color:#E1E4E8"> runtime</span></span>
<span class="line"><span style="color:#6A737D"># COPY --from=prod-deps /app/node_modules ./node_modules</span></span>
<span class="line"><span style="color:#F97583">COPY</span><span style="color:#E1E4E8"> --from=build /app/dist ./dist</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">ENV</span><span style="color:#E1E4E8"> HOST=0.0.0.0</span></span>
<span class="line"><span style="color:#F97583">ENV</span><span style="color:#E1E4E8"> PORT=4321</span></span>
<span class="line"><span style="color:#F97583">EXPOSE</span><span style="color:#E1E4E8"> 4321</span></span>
<span class="line"><span style="color:#F97583">CMD</span><span style="color:#E1E4E8"> node ./dist/server/entry.mjs</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="log"><code><span class="line"><span style="color:#E1E4E8"> docker build -t v2 .</span></span>
<span class="line"><span style="color:#E1E4E8">[+] Building </span><span style="color:#79B8FF">24</span><span style="color:#E1E4E8">.9s (</span><span style="color:#79B8FF">13</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">13</span><span style="color:#E1E4E8">) FINISHED                                                                                                                                         docker:orbstack</span></span>
<span class="line"><span style="color:#E1E4E8"> => [internal] load build definition from Dockerfile                                                                                                                                   </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => transferring dockerfile: 708B                                                                                                                                                   </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [internal] load metadata for docker.io/library/node:lts-alpine                                                                                                                     </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">.7s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [internal] load .dockerignore                                                                                                                                                      </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => transferring context: 89B                                                                                                                                                       </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [base </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">] FROM docker.io/library/node:lts-alpine@sha256:1a526b97cace6b4006256570efa1a29cd1fe4b96a5301f8d48e87c5139438a45                                                          </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [internal] load build context                                                                                                                                                      </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.3s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => transferring context: </span><span style="color:#79B8FF">240</span><span style="color:#E1E4E8">.47kB                                                                                                                                                  </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.2s</span></span>
<span class="line"><span style="color:#E1E4E8"> => CACHED [base </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">] RUN corepack enable                                                                                                                                              </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => CACHED [base </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">] WORKDIR /app                                                                                                                                                     </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => CACHED [base </span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">] COPY </span><span style="color:#79B8FF">package.json</span><span style="color:#79B8FF"> pnpm-lock.yaml</span><span style="color:#E1E4E8"> ./                                                                                                                              </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => CACHED [build-deps </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">] RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile                                                                           </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [build </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">] COPY . .                                                                                                                                                               </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">.5s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [build </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">] RUN export $(cat .</span><span style="color:#79B8FF">env.example</span><span style="color:#E1E4E8">) &#x26;&#x26; export DOCKER=</span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8"> &#x26;&#x26; pnpm run build                                                                                                </span><span style="color:#79B8FF">15</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => [runtime </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">/</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">] COPY --from=build /app/dist ./dist                                                                                                                                   </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.1s</span></span>
<span class="line"><span style="color:#E1E4E8"> => exporting to image                                                                                                                                                                 </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.1s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => exporting layers                                                                                                                                                                </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.1s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => writing image sha256:0ed5c10162d1faf4208f5ea999fbcd133374acc0e682404c8b05220b38fd1eaf                                                                                           </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">.0s</span></span>
<span class="line"><span style="color:#E1E4E8"> => => naming to docker.io/library/v2</span></span></code></pre>
<p>In the end, the size was reduced from 1.06GB to 135MB, and the build time was reduced from 113.8s to 24.9s.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="log"><code><span class="line"><span style="color:#E1E4E8">docker images</span></span>
<span class="line"><span style="color:#E1E4E8">REPOSITORY                         TAG         IMAGE ID       CREATED          SIZE</span></span>
<span class="line"><span style="color:#E1E4E8">v2                                 latest      0ed5c10162d1   </span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8"> minutes ago    135MB</span></span>
<span class="line"><span style="color:#E1E4E8">v1                                 latest      8ae6b2bddf0a   </span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8"> minutes ago    306MB</span></span>
<span class="line"><span style="color:#E1E4E8">v0                                 latest      653236defcbb   </span><span style="color:#79B8FF">11</span><span style="color:#E1E4E8"> minutes ago   </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">.06GB</span></span></code></pre>
<p>The example project is open-source and can be viewed on <a href="https://github.com/ccbikai/BroadcastChannel/pkgs/container/broadcastchannel">GitHub</a>.</p>
<p><a href="https://github.com/ccbikai/BroadcastChannel"><img src="https://github.html.zone/ccbikai/BroadcastChannel" alt="BroadcastChannel"></a></p>