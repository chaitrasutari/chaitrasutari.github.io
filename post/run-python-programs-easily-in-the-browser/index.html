<!DOCTYPE html><p>Microsoft recently open-sourced <a href="https://github.com/microsoft/markitdown">MarkItDown</a>, a program that converts Office files to Markdown format. The project quickly climbed to GitHub’s trending list upon release.</p>
<p>However, since MarkItDown is a Python program, it might be challenging for non-technical users to use. To address this issue, I thought of using WebAssembly technology to run Python code directly in the browser.</p>
<p>Pyodide is an open-source program that runs Python in the browser, using WebAssembly to port CPython, so it supports all Python syntax. Cloudflare’s Python Workers also use Pyodide.</p>
<blockquote>
<p>Pyodide is a port of CPython to WebAssembly/Emscripten.</p>
<p>Pyodide makes it possible to install and run Python packages in the browser using micropip. Any pure Python package with wheels available on PyPI is supported.</p>
<p>Many packages with C extensions have also been ported for use with Pyodide. These include common packages like regex, PyYAML, lxml, and scientific Python packages including NumPy, pandas, SciPy, Matplotlib, and scikit-learn. Pyodide comes with a robust JavaScript ⟺ Python foreign function interface that allows you to freely mix these languages in your code with minimal friction. This includes comprehensive support for error handling, async/await, and more.</p>
<p>When used in the browser, Python has full access to the Web APIs.</p>
</blockquote>
<p>Trying to run MarkItDown was surprisingly smooth, proving that WebAssembly is truly the future of browsers.</p>
<p>The main challenges faced and solutions:</p>
<ol>
<li>
<p><strong>File Transfer Issue</strong>: How to pass user-selected files to the Python runtime in the Worker?</p>
</li>
<li>
<p><strong>Dependency Installation Issue</strong>: Limited access to PyPI in mainland China.</p>
</li>
</ol>
<p>Eventually, we successfully implemented a MarkItDown tool that runs entirely in the browser. Feel free to try it out at <a href="https://www.html.zone/markitdown/">Office File to Markdown</a>.</p>
<p><a href="https://www.html.zone/markitdown/"><img src="https://www.html.zone/markitdown.png" alt="Office File to Markdown"></a></p>
<p>Here’s the core code for running Python in the Worker:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#6A737D">// eslint-disable-next-line no-undef</span></span>
<span class="line"><span style="color:#B392F0">importScripts</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'https://testingcf.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">async</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> loadPyodideAndPackages</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">  // eslint-disable-next-line no-undef</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> pyodide</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> loadPyodide</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">  globalThis.pyodide </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pyodide</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  await</span><span style="color:#E1E4E8"> pyodide.</span><span style="color:#B392F0">loadPackage</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'micropip'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> micropip</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> pyodide.</span><span style="color:#B392F0">pyimport</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'micropip'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // micropip.set_index_urls([</span></span>
<span class="line"><span style="color:#6A737D">  // 'https://pypi.your.domains/pypi/simple',  </span></span>
<span class="line"><span style="color:#6A737D">  // ])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  await</span><span style="color:#E1E4E8"> micropip.</span><span style="color:#B392F0">install</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'markitdown==0.0.1a2'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> pyodideReadyPromise</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> loadPyodideAndPackages</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">globalThis.</span><span style="color:#B392F0">onmessage</span><span style="color:#F97583"> =</span><span style="color:#F97583"> async</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">event</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  await</span><span style="color:#E1E4E8"> pyodideReadyPromise</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> file</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> event.data</span></span>
<span class="line"><span style="color:#F97583">  try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'file'</span><span style="color:#E1E4E8">, file)</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> startTime</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Date.</span><span style="color:#B392F0">now</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    globalThis.pyodide.</span><span style="color:#79B8FF">FS</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">writeFile</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`/${</span><span style="color:#E1E4E8">file</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">filename</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">, file.buffer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> globalThis.pyodide.</span><span style="color:#B392F0">runPythonAsync</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`</span></span>
<span class="line"><span style="color:#9ECBFF">from markitdown import MarkItDown</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">markitdown = MarkItDown()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">result = markitdown.convert("/${</span><span style="color:#E1E4E8">file</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">filename</span><span style="color:#9ECBFF">}")</span></span>
<span class="line"><span style="color:#9ECBFF">print(result.text_content)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">with open("/${</span><span style="color:#E1E4E8">file</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">filename</span><span style="color:#9ECBFF">}.md", "w") as file:</span></span>
<span class="line"><span style="color:#9ECBFF">  file.write(result.text_content)</span></span>
<span class="line"><span style="color:#9ECBFF">`</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    globalThis.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      filename: </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">file</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">filename</span><span style="color:#9ECBFF">}.md`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      content: globalThis.pyodide.</span><span style="color:#79B8FF">FS</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">readFile</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`/${</span><span style="color:#E1E4E8">file</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">filename</span><span style="color:#9ECBFF">}.md`</span><span style="color:#E1E4E8">, { encoding: </span><span style="color:#9ECBFF">'utf8'</span><span style="color:#E1E4E8"> }),</span></span>
<span class="line"><span style="color:#E1E4E8">      time: Date.</span><span style="color:#B392F0">now</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> startTime,</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  catch</span><span style="color:#E1E4E8"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8">    globalThis.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">({ error: error.message </span><span style="color:#F97583">||</span><span style="color:#9ECBFF"> 'convert error'</span><span style="color:#E1E4E8">, filename: file.filename })</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>