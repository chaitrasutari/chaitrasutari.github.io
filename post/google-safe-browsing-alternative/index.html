<!DOCTYPE html><p>So, get this, right? I built the first version of <a href="https://loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo.ong/">L(O*62).ONG</a> using server-side redirects, but Google slapped me with a security warning the very next day. Talk about a buzzkill! I had to scramble and switch to local redirects with a warning message before sending folks on their way. Then came the fun part – begging Google for forgiveness.</p>
<p>Now, the smart money would’ve been on using Google Safe Browsing for redirects. But here’s the catch: Safe Browsing’s got a daily limit – 10,000 calls, and that’s it. Plus, no custom lists. And since I’m all about keeping things simple and sticking with Cloudflare, Safe Browsing was a no-go.</p>
<p>Fast forward to a while back, I was chewing the fat with someone online, and bam! It hit me like a bolt of lightning. Why not use a secure DNS server with built-in filters for adult content and all that shady stuff to check if a domain’s on the up-and-up?  Figured I’d give <a href="https://blog.cloudflare.com/zh-cn/introducing-1-1-1-1-for-families-zh-cn/">Family 1.1.1.1</a> a shot, and guess what? It actually worked!  Problem was, no custom lists there either.  Then I remembered messing around with Cloudflare Zero Trust Gateway back in my <a href="https://www.awesome-homelab.com/">HomeLab</a> days.  Turns out, that was the golden ticket – a solution so good, it’s almost criminal.</p>
<p><strong>Here’s the deal: Cloudflare Zero Trust’s Gateway comes packing a built-in DNS (DoH) server and lets you set up firewall rules like a boss. You can block stuff based on how risky a domain is, what kind of content it has, and even use your own custom naughty-and-nice lists. And get this – it pulls data from Cloudflare’s own stash, over 30 open intelligence sources, fancy machine learning models, and even feedback from the community. Talk about covering all the bases! Want the nitty-gritty?  Hit up the <a href="https://developers.cloudflare.com/cloudflare-one/policies/gateway/domain-categories/#docs-content">official documentation</a>.</strong></p>
<p>So, I went ahead and blocked all the high-risk categories – adult stuff, gambling sites, government domains, anything NSFW, newly registered domains, you name it. Plus, I’ve got my own little blacklists and whitelists that I keep nice and tidy.</p>
<p><img src="https://static.miantiao.me/share/2024/ROJmki/CleanShot%202024-07-07%20at%2022.22.25.png" alt="Risk List"></p>
<p>Once I was done tweaking the settings, I got myself a shiny new DoH address:</p>
<p><img src="https://static.miantiao.me/share/2024/iY5dK8/CleanShot%202024-07-07%20at%2022.26.23.png" alt="DoH"></p>
<p>To hook it up to my project, I used this handy-dandy code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">async</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> isSafeUrl</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">  url</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">  DoH</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "https://family.cloudflare-dns.com/dns-query"</span></span>
<span class="line"><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> safe </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">hostname</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> URL</span><span style="color:#E1E4E8">(url);</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> res</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">DoH</span><span style="color:#9ECBFF">}?type=A&#x26;name=${</span><span style="color:#E1E4E8">hostname</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">      headers: {</span></span>
<span class="line"><span style="color:#E1E4E8">        accept: </span><span style="color:#9ECBFF">"application/dns-json"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">      cf: {</span></span>
<span class="line"><span style="color:#E1E4E8">        cacheEverything: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        cacheTtlByStatus: { </span><span style="color:#9ECBFF">"200-299"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">86400</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> dnsResult</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> res.</span><span style="color:#B392F0">json</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (dnsResult </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> Array.</span><span style="color:#B392F0">isArray</span><span style="color:#E1E4E8">(dnsResult.Answer)) {</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> isBlock</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> dnsResult.Answer.</span><span style="color:#B392F0">some</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">        answer</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> answer.data </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> "0.0.0.0"</span></span>
<span class="line"><span style="color:#E1E4E8">      );</span></span>
<span class="line"><span style="color:#E1E4E8">      safe </span><span style="color:#F97583">=</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">isBlock;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (e) {</span></span>
<span class="line"><span style="color:#E1E4E8">    console.</span><span style="color:#B392F0">warn</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"isSafeUrl fail: "</span><span style="color:#E1E4E8">, url, e);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> safe;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>And here’s the kicker: Cloudflare Zero Trust’s management panel has this sweet visualization interface that lets you see what’s getting blocked and what’s not.  You can see for yourself – it’s got the kibosh on some adult sites and those brand-spanking-new domains.</p>
<p><img src="https://static.miantiao.me/share/2024/5hOp5X/CleanShot%202024-07-07%20at%2022.30.36.png" alt="Visualization Interface"></p>
<p>Oh, and if a domain ends up on the wrong side of the tracks, you can always check the log to see what went down.</p>
<p><img src="https://static.miantiao.me/share/2024/EmRMB3/52WCkd.png" alt="Log"></p>